<% layout("/layouts/boilerplate.ejs") %>

<!-- Animate.css -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />

<style>
  body {
    font-family: 'SF Pro Display', 'Inter', sans-serif;
    background: linear-gradient(135deg, #d0e8ff, #e6f2ff);
    color: #1c1c1e;
  }

  .glass-card {
    background: rgba(255, 255, 255, 0.35);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.25);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
  }

  .form-control, .form-select {
    border-radius: 1rem;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(10px);
    border: 1.5px solid rgba(200,200,200,0.5);
    font-size: 1rem;
  }

  .form-control:focus, .form-select:focus {
    border-color: #008cff;
    box-shadow: 0 0 0 0.25rem rgba(0, 140, 255, 0.3);
  }

  .btn-custom {
    border-radius: 1.5rem;
    transition: all 0.3s ease-in-out;
    background: linear-gradient(to right, #008cff, #0066ff);
    color: white;
    font-weight: 600;
    padding: 10px 40px;
    box-shadow: 0 6px 16px rgba(0, 140, 255, 0.35);
    border: none;
  }

  .btn-custom:hover {
    background: linear-gradient(to right, #5ca3c6, #5ca3c6);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(45, 134, 223, 0.5);
  }

  h2.text-center {
    font-size: 2.5rem;
    font-weight: 700;
    letter-spacing: 1px;
    background: linear-gradient(90deg, #000, #0080ff, #000);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-size: 200% auto;
    animation: lightSweep 3.5s linear infinite;
  }

  .text-muted {
    color: #555 !important;
  }

  @keyframes lightSweep {
    0% { background-position: 200% center; }
    100% { background-position: -200% center; }
  }
</style>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 animate__animated animate__fadeIn">
      <div class="glass-card p-5 text-dark">

        <!-- Title -->
        <h2 class="text-center mb-3 fw-bold">üìù Create a New Listing</h2>
        <p class="text-center text-muted mb-4 fst-italic">
          "Turn your unused items into opportunities ‚Äì list, bid, and win!"
        </p>

        <!-- FORM -->
        <form action="/listings" novalidate class="needs-validation" method="POST">
          <!-- Title -->
          <div class="mb-4">
            <label for="title" class="form-label">Title</label>
            <input type="text" placeholder="Add a title" name="listing[title]" class="form-control shadow-sm" required />
            <div class="valid-feedback">Title looks good!</div>
          </div>

          <!-- Description -->
          <div class="mb-4">
            <label for="description" class="form-label">Description</label>
            <textarea placeholder="Enter description" name="listing[description]" class="form-control shadow-sm" required></textarea>
            <div class="invalid-feedback">Please enter a valid description</div>
          </div>

          <!-- Dropdowns -->
          <div class="row">
            <div class="mb-3 col-md-4">
              <label for="category" class="form-label">Category</label>
              <select class="form-select shadow-sm" id="category" name="listing[category]" required>
                <option value="">Select</option>
                <option value="Electronics">Electronics</option>
                <option value="Furniture">Furniture</option>
                <option value="Books">Books</option>
                <option value="Fashion">Fashion</option>
                <option value="Antiques">Antiques</option>
              </select>
            </div>

            <div class="mb-3 col-md-4">
              <label for="brand" class="form-label">Brand</label>
              <select class="form-select shadow-sm" id="brand" name="listing[brand]" required>
                <option value="">Select</option>
                <option value="Apple">Apple</option>
                <option value="Samsung">Samsung</option>
                <option value="Sony">Sony</option>
                <option value="IKEA">IKEA</option>
                <option value="Nilkamal">Nilkamal</option>
                <option value="Penguin">Penguin</option>
                <option value="HarperCollins">HarperCollins</option>
                <option value="Zara">Zara</option>
                <option value="H&M">H&M</option>
                <option value="NoBrand">NoBrand</option>
              </select>
            </div>

            <div class="mb-3 col-md-4">
              <label for="condition" class="form-label">Condition</label>
              <select class="form-select shadow-sm" id="condition" name="listing[condition]" required>
                <option value="">Select</option>
                <option value="New">New</option>
                <option value="Used">Used</option>
                <option value="Refurbished">Refurbished</option>
              </select>
            </div>
          </div>

          <!-- Image -->
          <div class="mb-4">
            <label for="image" class="form-label">Image Link</label>
            <input type="text" placeholder="Enter image URL" name="listing[image]" class="form-control shadow-sm" />
          </div>

          <!-- AI Suggest Button -->
          <div class="mb-3 text-end">
            <button type="button" id="aiSuggestBtn" class="btn btn-outline-primary px-4">
              ü§ñ AI Price Suggest
            </button>
          </div>

          <!-- AI Price Suggestions -->
          <div class="row">
            <div class="mb-3 col-md-6">
              <label for="aiSuggestedStart" class="form-label">AI Suggested Start Bid</label>
              <input type="text" id="aiSuggestedStart" class="form-control shadow-sm" readonly />
            </div>
            <div class="mb-3 col-md-6">
              <label for="aiSuggestedMax" class="form-label">AI Estimated Max Bid</label>
              <input type="text" id="aiSuggestedMax" class="form-control shadow-sm" readonly />
            </div>
          </div>

          <!-- Use Suggested Price Checkbox -->
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="useSuggestedPrice">
            <label class="form-check-label text-muted" for="useSuggestedPrice">
              Use suggested price
            </label>
          </div>

          <!-- Price & Country -->
          <div class="row">
            <div class="mb-3 col-md-4">
              <label for="price" class="form-label">Price</label>
              <input id="price" placeholder="1200" name="listing[price]" class="form-control shadow-sm" required />
              <div class="invalid-feedback">Please enter a valid price</div>
            </div>

            <div class="mb-3 col-md-8">
              <label for="country" class="form-label">Country</label>
              <input type="text" placeholder="India" name="listing[country]" class="form-control shadow-sm" required />
              <div class="invalid-feedback">Please enter a valid country</div>
            </div>
          </div>

          <!-- Location -->
          <div class="mb-4">
            <label for="location" class="form-label">Location</label>
            <input type="text" placeholder="Vadodara, Gujarat" name="listing[location]" id="locationInput" class="form-control shadow-sm" required />
            <div class="invalid-feedback">Please enter a valid location</div>

            <button type="button" id="getLocationBtn" class="btn btn-outline-secondary btn-sm mt-2">
              üìç Auto-fill My Location
            </button>
          </div>

          <!-- Bidding Start Time -->
          <div class="mb-4">
            <label for="startTime" class="form-label">Bidding Start Date & Time</label>
            <input type="datetime-local" class="form-control shadow-sm" name="listing[startTime]" required />
          </div>

          <!-- Bidding End Time -->
          <div class="mb-4">
            <label for="endTime" class="form-label">Bidding End Date & Time</label>
            <input type="datetime-local" class="form-control shadow-sm" name="listing[endTime]" required />
          </div>

          <!-- Submit -->
          <div class="text-center mt-4">
            <button class="btn btn-custom px-5 py-2 shadow-lg">Add Listing</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Backend Data -->
<div id="ai-metadata"
     data-seller-rating="<%= typeof sellerRating !== 'undefined' ? sellerRating : 4.5 %>"
     data-similar-items="<%= typeof similarCount !== 'undefined' ? similarCount : 3 %>">
</div>

<!-- Scripts -->
<script src="/js/script.js"></script>
<script>
  // Location autofill logic
  document.getElementById("getLocationBtn").addEventListener("click", async () => {
    const locationInput = document.getElementById("locationInput");

    if (!navigator.geolocation) {
      alert("Geolocation is not supported by your browser.");
      return;
    }

    locationInput.placeholder = "Getting location...";

    navigator.geolocation.getCurrentPosition(async (position) => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        const data = await response.json();
        const address = data.address;
        const city = address.city || address.town || address.village || '';
        const state = address.state || '';
        const country = address.country || '';

        locationInput.value = `${city}, ${state}, ${country}`;
      } catch (error) {
        console.error("Error fetching address:", error);
        alert("Failed to fetch location.");
        locationInput.placeholder = "Vadodara, Gujarat";
      }
    }, () => {
      alert("Unable to retrieve your location.");
      locationInput.placeholder = "Vadodara, Gujarat";
    });
  });

  // Price checkbox sync
  document.addEventListener("DOMContentLoaded", () => {
    const aiStart = document.getElementById("aiSuggestedStart");
    const price = document.getElementById("price");
    const useSuggestedCheckbox = document.getElementById("useSuggestedPrice");

    if (aiStart && price && useSuggestedCheckbox) {
      useSuggestedCheckbox.addEventListener("change", () => {
        if (useSuggestedCheckbox.checked) {
          price.value = aiStart.value.replace(/[^\d.]/g, '');
        } else {
          price.value = '';
        }
      });

      aiStart.addEventListener("input", () => {
        if (useSuggestedCheckbox.checked) {
          price.value = aiStart.value.replace(/[^\d.]/g, '');
        }
      });
    }
  });
</script>
